# Backlink Generator

Automatically generates bidirectional backlinks for annotated markdown links in the GraphGRC documentation.

## Overview

The backlink generator scans markdown files for annotated links in the format:

```markdown
[Link Text](../path/to/file.md) ^[Annotation explaining the relationship]
```

It then builds a graph of all these links and automatically updates the `## Referenced By` section in target files with backlinks showing which documents reference them.

## Usage

### Generate Backlinks

```bash
make generate-backlinks
```

Or run directly:

```bash
go run cmd/generate-backlinks/main.go
```

### Command Line Options

- `-root <path>` - Specify repository root directory (defaults to current directory)
- `-verbose` - Enable verbose output showing link counts and processing details
- `-validate` - Only validate that files have backlink sections, don't update

### Validate Backlink Sections

Check if all files have the required `## Referenced By` section:

```bash
./bin/generate-backlinks -validate
```

## How It Works

### 1. Link Parsing

The generator scans these directories for annotated links:

- `controls/` - Security controls (organized by family)
- `standards/` - Technical standards
- `processes/` - Operational processes
- `policies/` - Security policies
- `charter/` - Program charter documents

**Note:** Framework directories (soc2, gdpr, iso27001, etc.) are NOT scanned for links - they only receive backlinks from controls.

### 2. Graph Building

Creates a bidirectional link graph:

```
Source: /controls/iam/multi-factor-authentication.md
  Links to: /standards/saas-iam-standard.md
    Annotation: "MFA requirements for all user access"

Target: /standards/saas-iam-standard.md
  Referenced by: /controls/iam/multi-factor-authentication.md
    Annotation: "MFA requirements for all user access"
```

### 3. Backlink Generation

Updates the `## Referenced By` section in target files with grouped backlinks:

```markdown
## Referenced By

*This section is automatically generated by `make generate-backlinks`. Do not edit manually.*

**Controls:**
- [Multi-Factor Authentication](../controls/iam/multi-factor-authentication.md) ^[MFA requirements for all user access]
- [Cloud IAM](../controls/iam/cloud-iam.md) ^[IAM role-based access with least privilege]

**Standards:**
- [Cryptography Standard](../standards/cryptography-standard.md) ^[TLS 1.2+ requirement]
```

## Document Types

Backlinks are grouped by document type:

- **Controls** - Security controls from `/controls` (organized by family: IAM, cryptography, data management, etc.)
- **Standards** - Technical standards from `/standards`
- **Processes** - Operational processes from `/processes`
- **Policies** - Security policies from `/policies`
- **Charter** - Program charter from `/charter`
- **Framework Controls** - SOC2, GDPR, ISO, NIST controls

## Adding Backlink Sections

If files don't have the `## Referenced By` section, use the helper tool:

```bash
go run cmd/add-backlink-sections/main.go
```

This adds the section to all files in:
- standards/
- processes/
- policies/
- charter/
- soc2/
- gdpr/
- iso27001/
- iso27002/
- nist80053/
- scf/

Use `--dry-run` to preview changes without modifying files.

## Architecture

### Packages

- **internal/parser/links.go** - Parses markdown files to extract annotated links
- **internal/parser/graph.go** - Builds bidirectional link graph
- **internal/generator/backlinks.go** - Generates and updates backlink markdown
- **cmd/generate-backlinks/main.go** - CLI entry point
- **cmd/add-backlink-sections/main.go** - Helper to add sections to files

### Link Pattern

The regex pattern for annotated links:

```go
\[([^\]]+)\]\(([^)]+\.md)\)\s*\^\[([^\]]+)\]
```

Matches:
- `[text]` - Link text
- `(path.md)` - Relative path to target file
- `^[annotation]` - Annotation explaining the relationship

### Path Resolution

Links use relative paths (e.g., `../standards/aws.md`). The generator:

1. Normalizes to repo-relative paths (`/standards/aws.md`)
2. Builds the graph using absolute paths from repo root
3. Calculates relative paths for backlinks based on target location

### Avoiding Feedback Loops

The parser excludes the `## Referenced By` section when scanning files to avoid parsing generated backlinks as source links. This prevents duplicate entries and feedback loops.

## Example Workflow

1. **Write a control** with annotated links:

```markdown
# Multi-Factor Authentication

## Implementation

**Standards:**
- [SaaS IAM Standard](../../standards/saas-iam-standard.md) ^[MFA requirements for all user access]

## Framework Mapping

**SOC 2:**
- [CC6.1](../../frameworks/soc2/cc61.md) ^[Strong authentication implements logical access security]
```

2. **Run the generator**:

```bash
make generate-backlinks
```

3. **Check the results**:

`standards/saas-iam-standard.md` now has:

```markdown
## Implemented By

**Controls:**
- [Multi-Factor Authentication](../controls/iam/multi-factor-authentication.md) ^[MFA requirements for all user access]
```

`frameworks/soc2/cc61.md` now has:

```markdown
## Referenced By

**Controls:**
- [Multi-Factor Authentication](../../controls/iam/multi-factor-authentication.md) ^[Strong authentication implements logical access security]
```

## Error Handling

The generator handles errors gracefully:

- **Missing files** - Warns but continues processing
- **Missing sections** - Warns that file doesn't have `## Referenced By` section
- **Malformed links** - Skips individual links but continues processing
- **Path resolution errors** - Logs warning and skips the link

## Integration with Make

The `Makefile` includes the backlink generator in the full generation pipeline:

```makefile
generate: generate-frameworks generate-custom generate-backlinks
```

This ensures backlinks are always up to date when generating documentation.

## Performance

Typical performance on the GraphGRC repository:

- **Files scanned**: ~1,050 markdown files
- **Links processed**: ~180 annotated links
- **Files updated**: ~60 files with backlinks
- **Time**: < 1 second

## Troubleshooting

### Links not appearing

1. Check link format - must match `[text](path.md) ^[annotation]`
2. Verify relative path is correct
3. Ensure target file exists
4. Run with `-verbose` to see detailed processing

### Duplicate backlinks

1. Check if `## Referenced By` section appears multiple times
2. Verify the parser is excluding the backlink section
3. Re-run generator to clean up duplicates

### Wrong relative paths

The generator should handle all relative path calculations. If paths are incorrect:

1. Check that repo root is detected correctly
2. Verify file paths don't contain symbolic links
3. Ensure files are within the repository

## Development

### Running Tests

```bash
go test ./internal/parser/...
go test ./internal/generator/...
```

### Adding New Document Types

Edit `internal/parser/graph.go` to add a new document type:

```go
const (
    TypeNewType DocumentType = "New Type Name"
)

func getDocumentType(filePath string) DocumentType {
    switch {
    case strings.HasPrefix(filePath, "newdir/"):
        return TypeNewType
    // ...
    }
}
```

### Modifying Link Format

Edit the regex pattern in `internal/parser/links.go`:

```go
var linkPattern = regexp.MustCompile(`your-pattern-here`)
```
